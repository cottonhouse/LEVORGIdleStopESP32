# LEVORGIdleStopCanceler uses ESP32-C3-WROOM-02
　Idling Stop Setting Value Reserver (ESP32-C3) (Idle Stop Canceler)  
　for SUBARU LEVORG VN5(2020-)

# Name
　SUBARU LEVORG VN5 Idling Stop Setting Value Reserver (Idle Stop Canceler)  

　LEVORGのアイドリングストップ設定を保存し、次回のエンジン起動時に復元する実験をしました。  
 　
# Features
　スバルのLEVORG(VN5 2020-)は、エンジン起動時に必ずアイドリングストップがONになってしまいます。  
　アイドリングストップが不要なユーザーにとっては、エンジンを掛ける度にOFFにしなければならず、いささか面倒です。  
　この実験により、ON/OFFの状態を保存しておき、エンジン始動時に設定を復元させることができました。  

  これ以前に別途にArduino Leonardで実験したものをESP32-C3に移植し、OTA(WiFiによるプログラム書き換え)の機能を
  追加しています。
  また、ドライバーモニタリングシステムと車体ハーネスの間に本デバイスを割り込ませられるように基板を作成しました。

  以前のものは以下です。
  [https://github.com/cottonhouse/LEVORGIdleStopCanceler](https://github.com/cottonhouse/LEVORGIdleStopCanceler)

# Requirement
ハードウェア
 以下に使用した部品を挙げますが、車載グレードでは無いものも含まれています。車に常設しようと考えている方は、
 熱暴走やノイズによる動作不具合の可能性もあることを念頭において、ご自分の責任でご利用ください。
-ESP32-C3-WROOM02-N4  (参考価格 310円)
 ESP32シリーズはCANコントローラの機能を内蔵していますので、ESP32とCANレシーバがあればCANパケットの受信が可能です。
-SN65HVD230 (SOIC8) CANレシーバ (参考価格 470円 但し通販でしか見かけないため送料が掛かる)
 (実際にはHVD232を使用しています。230/231/232いずれでも利用可能です。)
-[LT1117CST-3.3 3端子レギュレータ](https://akizukidenshi.com/catalog/g/gI-07283/) (参考価格 750円)
 (SOT-223で15V入力できる3.3V800mA程度以上の出力のもの。Pin配列は GND,OUT,IN)
 秋月電子にありますが、1個750円とレギュレータとしては高めの価格です。出力800mA以上で上記の条件に合うものなら、
 他のレギュレータでも利用可能と思います。注意事項としては、15V入力可能と記載があっても、出力5V以上のラインナップだけが
 15Vで3.3Vのものは12Vまで、というようなことがあります。データシートで3.3Vの入力電圧範囲を確認してください。
-表面実装抵抗(0805(2012)) 10KΩ x 4個 (参考価格 100円/5-10個1パック)
-表面実装コンデンサ(0805(2012) チップ積層セラミック) 10uF x 2個、0.01uF x 4個　(参考価格 100円/10個1パック)
-JST XHコネクタ 直角オス5pin、メス5pin
-[表面実装タクトスイッチ 3mmx6mm x 2個](https://www.amazon.co.jp/uxcell-マイクロタクトスイッチ-押しボタン-3x6x4-3mm-20枚入り/dp/B07H7FYVXN/ref=sr_1_76?crid=1BWGO0RR560W6&keywords=タクトスイッチ+6mm+2ピン&qid=1698668502&sprefix=タクトスイッチ+6mm+%2Caps%2C153&sr=8-76)
-ジャンパピン 2.54ピッチ 4pin、2pin(2pinはオプション)
-車体用カプラ TE 1376366(オス) (参考価格 347円 Mouser) 
-車体用カプラ TE 1376368(メス) (参考価格 220円 配線COM) + ピン(参考価格 44円)(4本)
　結線カシメ時に失敗する可能性もありますのでピンは予備があると安心です
-カプラ取り付けねじ タッピング M3x6mm x 2本 (参考価格 107円)
-プログラム書き込み用に USB to SERIALコンバータが必要です。(FT232RLモジュールなど 300円程度)

ソフトウェア  
-Arduino IDE  
-[collin80/esp32_can ライブラリ(GitHub)](https://github.com/collin80/esp32_can)
-[collin80/can_common ライブラリ(GitHub)](https://github.com/collin80/can_common)
-VN5_IDLESTOP_ESP32C3_202312_01_GITHUB.ino

# Installation
ハードウェア
  zipファイルが基板のデータです。
  SeeedStudioのFusionPCBにそのまま製造を依頼すれば、送料込みで3000円しないで10枚の基板ができます。（1ロット最低10枚から）
  発注してから手元に着くまでの日数は、東京で大体8〜9日前後です。(配達会社にOCSを選択した場合)
  基板の素材や厚み等はそのままで大丈夫です。レジストの色はお好みで変更すると良いと思いますが、緑色が一番エラーが
  起きにくいと聞いたことがあります。私は赤が好きなので毎回赤色にしています。

　ハンダ付けで困ることは無いと思いますが、表面実装の部品をハンダ付けした経験が無い方はESP32-C3のハンダ付けが
  難しいかも知れません。Youtubeに表面実装部品のハンダ付けの解説動画がありますので、参考になさると良いと思います。

ソフトウェア
　VN5_IDLESTOP_ESP32C3_202312_01_GITHUB.ino を、Arduino IDEを使って書き込んでください。  
　書き込みにはUSB to Serialコンバータを使います。電圧は5Vに設定して5V-20Vと記載のあるピンに繋いでください。
　RXDとTXDは、各デバイスから見た受信/送信なので、RXD-TXD、TXD-RXDのように、受信を送信に/送信を受信に繋ぎます。

# Usage
  基板に部品をハンダ付けして、コネクタを結線します。コネクタの配線の長さは10cm程度です。
  CANの配線は捻ってTwist Pairにした方がノイズが軽減できると思います。
  また、基板は絶縁処理して車体に触れてもショートしないようにしてください。熱収縮チューブだと60mmφ程度のものが使えます。
  配線はエプトシーラ等で振動音対策をした方が良いでしょう。

　設置は車体のバッテリーを外した状態が良いと思います。
  設置したらバッテリーを接続し、エンジンを掛けてアイドリングストップの設定を変更した後にエンジンをOFFにし、再度エンジンを
  ONにして設定が保存されることを確認してください。  

# Note
  基板設計するにあたり、ノイズ低減に気を付けています。
  電源周りは他の回路から離してあります。また、各ICの電源部にはバイパスコンデンサを付与しています。
  ですが、素人のやることなので限界があります。

　実験結果として、アイドリングストップの設定値の保存と復元ができました。  
　本プログラムはあくまで実験用です。日常用途などで継続的に利用することを想定していませんので、皆さんが追実験する場合も
  動作確認や実験までに留め、日常的に利用するといったことはおやめください。  
　（自動車に関することですので、想定されていない日常的な利用は危険が伴う可能性があります。）  
　なお、VN5A(A型)でしか動作確認をしていません。A型以外では不具合が生じる可能性があります。  

　本プログラムはMITライセンスに準拠します。  
　下記のライセンスに記載されているように、本プログラムを利用した場合の損害等を含めた一切について、作成者である私Cottonhouseは
  責を負いません。  
　本プログラムを利用するということは、ライセンスに同意したということですので、ご自分の責任で利用なさってください。  
　また、本プログラムはAS ISです。あるがままで、不具合等ある可能性があります。  
　作者は動作の保証をしませんし、不具合の改修の責も負いません。  

# Author
* 作成者：Cottonhouse as [にゃんカラ](https://minkara.carview.co.jp/userid/2407630/profile/)

# License
"Idling Stop Setting Value Reserver (ESP32-C3)" is under [MIT license](https://en.wikipedia.org/wiki/MIT_License).

Copyright (c) 2023 Cottonhouse
Released under the MIT license
https://opensource.org/licenses/mit-license.php

MITライセンスですので商用利用可ですが、ライセンスに則ってCopyright表示とMITライセンスの全文URL表示をお願いします。